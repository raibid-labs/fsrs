#!/bin/bash
# Pre-commit hook for FSRS
# Install: ln -s ../../.githooks/pre-commit .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Change to repository root
cd "$(git rev-parse --show-toplevel)"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo_success() {
    echo -e "${GREEN}✓${NC} $1"
}

echo_error() {
    echo -e "${RED}✗${NC} $1"
}

echo_info() {
    echo -e "${YELLOW}ℹ${NC} $1"
}

# Check if we're in the right directory
if [ ! -f "justfile" ]; then
    echo_error "Not in FSRS repository root"
    exit 1
fi

# 1. Check formatting
echo_info "Checking code formatting..."
if just fmt-check > /dev/null 2>&1; then
    echo_success "Code formatting OK"
else
    echo_error "Code formatting issues found"
    echo "Run 'just fmt' to fix formatting"
    exit 1
fi

# 2. Run clippy
echo_info "Running clippy..."
if just lint > /dev/null 2>&1; then
    echo_success "Clippy checks passed"
else
    echo_error "Clippy found issues"
    echo "Run 'just lint' to see details"
    exit 1
fi

# 3. Check compilation
echo_info "Checking compilation..."
if just check-compile > /dev/null 2>&1; then
    echo_success "Compilation check passed"
else
    echo_error "Compilation failed"
    exit 1
fi

# 4. Run fast unit tests
echo_info "Running unit tests..."
if just test-unit > /dev/null 2>&1; then
    echo_success "Unit tests passed"
else
    echo_error "Unit tests failed"
    echo "Run 'just test-unit' to see details"
    exit 1
fi

# 5. Check for debug statements in Rust files
echo_info "Checking for debug statements..."
if git diff --cached --name-only | grep "\.rs$" | xargs grep -n "dbg!\|println!" 2>/dev/null; then
    echo_error "Found debug statements (dbg! or println!) in staged files"
    echo "Please remove them before committing"
    exit 1
else
    echo_success "No debug statements found"
fi

# 6. Check for large files
echo_info "Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only | xargs ls -l 2>/dev/null | awk '$5 > 1048576 {print $9}')
if [ -n "$LARGE_FILES" ]; then
    echo_error "Found large files (>1MB):"
    echo "$LARGE_FILES"
    exit 1
else
    echo_success "No large files found"
fi

echo ""
echo_success "All pre-commit checks passed!"
echo ""

exit 0
