name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Fast check job - runs first for quick feedback
  check:
    name: Quick Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Check formatting
        run: just fmt-check

      - name: Run clippy
        run: just lint

      - name: Check compilation
        run: just check-compile

  # MSRV (Minimum Supported Rust Version) check
  msrv-check:
    name: MSRV Check
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup Rust MSRV toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.70.0"

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
          key: msrv-1.70.0

      - name: Check compilation with MSRV
        run: |
          cd rust
          cargo check --workspace --all-features

      - name: Run tests with MSRV
        run: |
          cd rust
          cargo test --workspace

  # Test suite - runs in parallel with different configurations
  test:
    name: Test Suite
    needs: check
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, beta]
        exclude:
          # Only run beta on Ubuntu to save CI minutes
          - os: macos-latest
            rust: beta
          - os: windows-latest
            rust: beta
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: '*'

      - name: Build all crates
        run: just build

      - name: Run unit tests
        run: just test-unit

      - name: Run integration tests
        run: just test-integration
        continue-on-error: true  # Integration tests may not exist yet

      - name: Run VM tests
        run: just test-vm

      - name: Run frontend tests
        run: just test-frontend

  # Build release binaries to ensure release mode works
  build-release:
    name: Release Build
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build release binaries
        run: just build-release

      - name: Upload demo binary
        uses: actions/upload-artifact@v4
        with:
          name: fusabi-linux
          path: rust/target/release/fus
          if-no-files-found: warn

  # Code coverage with tarpaulin
  coverage:
    name: Code Coverage
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: |
          cd rust
          cargo tarpaulin --workspace --timeout 300 --out xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./rust/cobertura.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: |
          cd rust
          cargo audit

  # Dependency check - find outdated dependencies
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check for outdated dependencies
        run: just outdated
        continue-on-error: true

  # Documentation build check
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build documentation
        run: |
          cd rust
          cargo doc --workspace --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # Documentation freshness check
  docs-freshness:
    name: Documentation Freshness
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: '*'

      - name: Generate documentation
        run: nu scripts/gen-docs.nu

      - name: Check docs are up to date
        run: |
          if ! git diff --exit-code docs/STDLIB_REFERENCE.md; then
            echo "::error::Documentation is stale! Run 'nu scripts/gen-docs.nu' and commit the changes."
            exit 1
          fi

      - name: Check documentation structure
        run: |
          # Check required documentation files exist
          required_files=(
            "docs/STRUCTURE.md"
            "docs/RELEASE.md"
            "docs/01-overview.md"
            "docs/02-language-spec.md"
            "docs/03-vm-design.md"
            "docs/STDLIB_REFERENCE.md"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "::error::Missing required documentation files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

          # Check for forbidden content (AI notes)
          if find docs -type f \( -name "*notes*.md" -o -name "*instructions*.md" \) | grep -q .; then
            echo "::error::Found AI notes or instructions files in docs/. These should not be committed."
            find docs -type f \( -name "*notes*.md" -o -name "*instructions*.md" \)
            exit 1
          fi

          echo "Documentation structure check passed!"

  # Benchmark - ensure benchmarks compile (don't run them in CI)
  benchmark-check:
    name: Benchmark Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Check benchmarks compile
        run: |
          cd rust
          cargo bench --workspace --no-run
        continue-on-error: true  # Benchmarks may not exist yet

  # All checks passed
  ci-success:
    name: CI Success
    needs: [check, msrv-check, test, build-release, coverage, security-audit, docs, docs-freshness]
    runs-on: ubuntu-latest
    steps:
      - name: Mark CI as successful
        run: echo "All CI checks passed!"
